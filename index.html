<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Florida Weather Alerts â€” NWS Live</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #020508;
    --panel: #080c14;
    --border: #161e2e;
    --text: #d8e8f4;
    --muted: #5a6e88;
    --accent: #00a8e8;
    --fl-gold: #f5a623;

    --warning:      #e01010;
    --warning-bg:   rgba(224,16,16,0.13);
    --warning-glow: rgba(224,16,16,0.5);

    --watch:        #d4a017;
    --watch-bg:     rgba(212,160,23,0.13);
    --watch-glow:   rgba(212,160,23,0.4);

    --advisory:     #1e88d4;
    --advisory-bg:  rgba(30,136,212,0.13);
    --advisory-glow:rgba(30,136,212,0.3);

    --statement:    #33aa55;
    --statement-bg: rgba(51,170,85,0.12);
    --statement-glow:rgba(51,170,85,0.25);

    --lsr:          #cc44ee;
    --lsr-bg:       rgba(204,68,238,0.12);
    --lsr-glow:     rgba(204,68,238,0.35);

    --special:      #ff7a00;
    --special-bg:   rgba(255,122,0,0.12);
    --special-glow: rgba(255,122,0,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ FLASH OVERLAY for new alerts â”€â”€â”€ */
  #flashOverlay {
    position: fixed; inset: 0;
    background: rgba(224,16,16,0.18);
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity .15s;
  }
  #flashOverlay.flash { animation: flashPulse .8s ease-out forwards; }
  @keyframes flashPulse {
    0%   { opacity: 1; }
    40%  { opacity: .6; }
    100% { opacity: 0; }
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header {
    background: linear-gradient(180deg, #0c1220 0%, #080c14 100%);
    border-bottom: 2px solid var(--accent);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 66px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 40px rgba(0,168,232,0.12);
  }

  .logo-area { display: flex; align-items: center; gap: 14px; }

  .radar-icon { width: 42px; height: 42px; flex-shrink: 0; }
  .radar-icon svg { width: 100%; height: 100%; }

  .logo-text .sub {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700; font-size: 11px;
    letter-spacing: 4px; color: var(--fl-gold);
    text-transform: uppercase;
  }
  .logo-text .title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900; font-size: 28px;
    letter-spacing: 1px; text-transform: uppercase;
    color: #fff; line-height: 1;
  }
  .logo-text .title span { color: var(--fl-gold); }

  .header-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }
  .fl-outline {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 800;
    letter-spacing: 5px; text-transform: uppercase;
    color: rgba(245,166,35,0.4);
  }
  #newAlertBanner {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px; font-weight: 800;
    letter-spacing: 3px; text-transform: uppercase;
    color: var(--warning);
    text-shadow: 0 0 14px var(--warning-glow);
    opacity: 0;
    transition: opacity .3s;
  }
  #newAlertBanner.visible { opacity: 1; animation: blink 1s step-end 5; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  .header-right { display: flex; align-items: center; gap: 18px; }

  .sound-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase;
    padding: 5px 12px; border-radius: 2px;
    cursor: pointer; transition: all .15s;
    display: flex; align-items: center; gap: 6px;
  }
  .sound-btn.on  { border-color: var(--statement); color: var(--statement); }
  .sound-btn.off { border-color: var(--muted); color: var(--muted); }
  .sound-btn:hover { border-color: var(--accent); color: var(--accent); }

  .clock-area { text-align: right; }
  .clock-time {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px; color: #fff; letter-spacing: 1px;
  }
  .clock-date {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; color: var(--muted);
    text-transform: uppercase; letter-spacing: 1px;
  }

  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #33aa55; box-shadow: 0 0 8px #33aa55;
    animation: pulse-green 2s infinite;
  }
  .status-dot.error   { background: var(--warning); box-shadow: 0 0 8px var(--warning); animation: none; }
  .status-dot.loading { background: var(--watch); box-shadow: 0 0 8px var(--watch); animation: pulse-y 1s infinite; }
  @keyframes pulse-green { 0%,100%{opacity:1;box-shadow:0 0 6px #33aa55} 50%{opacity:.6;box-shadow:0 0 16px #33aa55} }
  @keyframes pulse-y { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€â”€ LEGEND / COUNT BAR â”€â”€â”€ */
  .info-bar {
    background: rgba(255,255,255,0.025);
    border-bottom: 1px solid var(--border);
    padding: 6px 20px;
    display: flex; gap: 16px; flex-wrap: wrap; align-items: center;
  }
  .info-bar span {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase;
    padding: 2px 8px; border-radius: 2px;
  }
  .leg-warning  { color:var(--warning);   background:var(--warning-bg);   border-left:2px solid var(--warning); }
  .leg-watch    { color:var(--watch);     background:var(--watch-bg);     border-left:2px solid var(--watch); }
  .leg-advisory { color:var(--advisory);  background:var(--advisory-bg);  border-left:2px solid var(--advisory); }
  .leg-statement{ color:var(--statement); background:var(--statement-bg); border-left:2px solid var(--statement); }
  .leg-lsr      { color:var(--lsr);       background:var(--lsr-bg);       border-left:2px solid var(--lsr); }
  .leg-special  { color:var(--special);   background:var(--special-bg);   border-left:2px solid var(--special); }
  .info-label   { color:var(--muted); font-size:12px; font-family:'Barlow Condensed',sans-serif; }
  .alert-count  { margin-left:auto; font-family:'Share Tech Mono',monospace; font-size:13px; color:var(--accent); }
  #lastUpdated  { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--muted); }

  /* â”€â”€â”€ FILTER BAR â”€â”€â”€ */
  .filter-bar {
    padding: 8px 20px;
    display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,0.2);
  }
  .filter-label { font-family:'Barlow Condensed',sans-serif; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
  .filter-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted); font-family:'Barlow Condensed',sans-serif;
    font-size: 12px; font-weight:700; letter-spacing:1px; text-transform:uppercase;
    padding: 4px 12px; border-radius:2px; cursor:pointer; transition:all .15s;
  }
  .filter-btn:hover { border-color:var(--accent); color:var(--accent); }
  .filter-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }

  .refresh-btn {
    margin-left: auto;
    background: none; border:1px solid var(--accent); color:var(--accent);
    font-family:'Barlow Condensed',sans-serif; font-size:12px; font-weight:700;
    letter-spacing:1px; text-transform:uppercase;
    padding: 4px 16px; border-radius:2px; cursor:pointer; transition:all .15s;
  }
  .refresh-btn:hover { background:var(--accent); color:#fff; }
  .refresh-btn.spinning { opacity:.5; pointer-events:none; }

  /* â”€â”€â”€ MAIN â”€â”€â”€ */
  main { padding: 14px 20px; max-width: 1600px; margin: 0 auto; }

  .section-header {
    font-family:'Barlow Condensed',sans-serif; font-size:11px; font-weight:800;
    letter-spacing:3px; text-transform:uppercase; color:var(--muted);
    margin: 14px 0 8px;
    display:flex; align-items:center; gap:10px;
  }
  .section-header::after { content:''; flex:1; height:1px; background:var(--border); }
  .section-header .badge {
    background: var(--accent); color:#fff;
    font-size:10px; padding:1px 7px; border-radius:10px;
  }

  /* â”€â”€â”€ NEW ALERT HIGHLIGHT â”€â”€â”€ */
  .alert-card.is-new {
    box-shadow: 0 0 0 1px var(--warning), 0 0 24px var(--warning-glow);
  }
  .alert-card.is-new .new-tag {
    display: inline-block;
  }
  .new-tag {
    display: none;
    font-family:'Barlow Condensed',sans-serif;
    font-size:10px; font-weight:900; letter-spacing:2px;
    text-transform:uppercase; color:#fff;
    background: var(--warning);
    padding: 1px 7px; border-radius:2px;
    margin-left:8px;
    animation: blink 1s step-end 6;
  }

  /* â”€â”€â”€ ALERT CARD â”€â”€â”€ */
  .alert-card {
    border-radius:3px; margin-bottom:7px;
    border-left:4px solid;
    display:grid; grid-template-columns: auto 1fr auto;
    overflow:hidden;
    animation: slideIn .3s ease-out;
    transition: opacity .6s, max-height .6s;
    position:relative;
  }
  @keyframes slideIn {
    from { opacity:0; transform:translateX(-16px); }
    to   { opacity:1; transform:translateX(0); }
  }
  .alert-card.expiring { animation: fadeOut .9s ease-in forwards; }
  @keyframes fadeOut { to { opacity:0; max-height:0; margin-bottom:0; } }

  .alert-card.warning  { border-color:var(--warning);   background:var(--warning-bg); }
  .alert-card.watch    { border-color:var(--watch);     background:var(--watch-bg); }
  .alert-card.advisory { border-color:var(--advisory);  background:var(--advisory-bg); }
  .alert-card.statement{ border-color:var(--statement); background:var(--statement-bg); }
  .alert-card.lsr      { border-color:var(--lsr);       background:var(--lsr-bg); }
  .alert-card.special  { border-color:var(--special);   background:var(--special-bg); }

  .alert-type-badge {
    writing-mode:vertical-rl; text-orientation:mixed; transform:rotate(180deg);
    font-family:'Barlow Condensed',sans-serif; font-size:10px; font-weight:800;
    letter-spacing:2px; text-transform:uppercase;
    padding:10px 6px; display:flex; align-items:center; justify-content:center;
    min-width:28px;
  }
  .alert-card.warning   .alert-type-badge { background:var(--warning-bg);   color:var(--warning); }
  .alert-card.watch     .alert-type-badge { background:var(--watch-bg);     color:var(--watch); }
  .alert-card.advisory  .alert-type-badge { background:var(--advisory-bg);  color:var(--advisory); }
  .alert-card.statement .alert-type-badge { background:var(--statement-bg); color:var(--statement); }
  .alert-card.lsr       .alert-type-badge { background:var(--lsr-bg);       color:var(--lsr); }
  .alert-card.special   .alert-type-badge { background:var(--special-bg);   color:var(--special); }

  .alert-body { padding:10px 14px; }

  .alert-headline {
    font-family:'Barlow Condensed',sans-serif; font-size:19px; font-weight:800;
    text-transform:uppercase; letter-spacing:.5px; color:#fff; line-height:1.1;
    margin-bottom:3px; display:flex; align-items:center; flex-wrap:wrap; gap:4px;
  }
  .alert-issued {
    font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--muted);
    margin-bottom:4px;
  }
  .alert-issued .issued-new { color: var(--fl-gold); font-weight:700; }
  .alert-areas {
    font-family:'Barlow Condensed',sans-serif; font-size:14px; color:var(--muted); margin-bottom:5px;
  }
  .alert-areas strong { color:var(--text); font-weight:600; }
  .alert-description {
    font-size:13px; color:#7a8fa8; line-height:1.45;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  .alert-description.expanded { -webkit-line-clamp:unset; }

  .alert-meta {
    padding:10px 14px 10px 10px;
    display:flex; flex-direction:column; align-items:flex-end;
    justify-content:space-between; gap:6px; min-width:165px;
    border-left:1px solid rgba(255,255,255,0.05);
  }
  .alert-expires {
    font-family:'Share Tech Mono',monospace; font-size:12px;
    color:var(--muted); text-align:right;
  }
  .alert-expires .exp-label {
    font-family:'Barlow Condensed',sans-serif; font-size:10px;
    letter-spacing:2px; text-transform:uppercase; color:#3a4a60; display:block;
  }
  .alert-expires.urgent { color:var(--warning); }
  .alert-expires.soon   { color:var(--watch); }
  .countdown-bar { width:100%; height:3px; background:rgba(255,255,255,0.05); border-radius:2px; overflow:hidden; min-width:120px; }
  .countdown-fill { height:100%; border-radius:2px; transition:width 60s linear; }
  .alert-card.warning   .countdown-fill { background:var(--warning); }
  .alert-card.watch     .countdown-fill { background:var(--watch); }
  .alert-card.advisory  .countdown-fill { background:var(--advisory); }
  .alert-card.statement .countdown-fill { background:var(--statement); }
  .alert-card.lsr       .countdown-fill { background:var(--lsr); }
  .alert-card.special   .countdown-fill { background:var(--special); }
  .nwso-tag { font-family:'Barlow Condensed',sans-serif; font-size:11px; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:#2a3a50; }
  .expand-btn {
    background:none; border:1px solid rgba(30,157,224,0.2); color:var(--accent);
    font-family:'Barlow Condensed',sans-serif; font-size:11px; font-weight:700;
    letter-spacing:1px; text-transform:uppercase; cursor:pointer;
    padding:2px 8px; border-radius:2px; margin-top:4px; transition:all .15s;
  }
  .expand-btn:hover { background:rgba(30,157,224,0.1); }

  /* â”€â”€â”€ LSR GRID â”€â”€â”€ */
  .lsr-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:8px; margin-bottom:8px; }
  .lsr-card {
    background:var(--lsr-bg); border:1px solid rgba(204,68,238,0.2);
    border-left:4px solid var(--lsr); border-radius:3px; padding:10px 12px;
    animation:slideIn .3s ease-out;
  }
  .lsr-card.is-new { box-shadow:0 0 0 1px var(--lsr), 0 0 18px var(--lsr-glow); }
  .lsr-card-header { display:flex; align-items:center; gap:8px; margin-bottom:5px; }
  .lsr-event-type { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:800; text-transform:uppercase; color:var(--lsr); flex:1; }
  .lsr-time { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--muted); }
  .lsr-magnitude { font-family:'Barlow Condensed',sans-serif; font-size:22px; font-weight:900; color:#fff; text-shadow:0 0 12px var(--lsr-glow); }
  .lsr-location { font-family:'Barlow Condensed',sans-serif; font-size:13px; color:var(--text); font-weight:600; }
  .lsr-reporter { font-size:11px; color:var(--muted); margin-top:3px; }
  .lsr-remark { font-size:12px; color:#7a8fa8; margin-top:5px; font-style:italic; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

  /* â”€â”€â”€ EMPTY / LOADING â”€â”€â”€ */
  .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty-state .big-icon { font-size:48px; margin-bottom:12px; opacity:.3; }
  .empty-state p { font-family:'Barlow Condensed',sans-serif; font-size:16px; letter-spacing:2px; text-transform:uppercase; }
  .loading-shimmer {
    background:linear-gradient(90deg, var(--panel) 25%, var(--border) 50%, var(--panel) 75%);
    background-size:200% 100%; animation:shimmer 1.5s infinite;
    border-radius:3px; height:72px; margin-bottom:7px;
  }
  @keyframes shimmer { from{background-position:200% 0} to{background-position:-200% 0} }
  .no-alerts-msg {
    font-family:'Barlow Condensed',sans-serif; font-size:14px; color:var(--muted);
    padding:16px; background:rgba(255,255,255,0.02); border:1px dashed var(--border);
    border-radius:3px; text-align:center; letter-spacing:1px; text-transform:uppercase;
  }

  /* â”€â”€â”€ TICKER â”€â”€â”€ */
  .ticker-wrap {
    position:fixed; bottom:0; left:0; right:0;
    background:#080c14; border-top:2px solid var(--accent);
    height:36px; overflow:hidden; display:flex; align-items:center; z-index:200;
  }
  .ticker-label {
    background:var(--fl-gold); color:#000;
    font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:900;
    letter-spacing:2px; text-transform:uppercase;
    padding:0 14px; height:100%; display:flex; align-items:center; flex-shrink:0; white-space:nowrap;
  }
  .ticker-content { display:flex; animation:tickerScroll 80s linear infinite; white-space:nowrap; padding-left:30px; }
  .ticker-content:hover { animation-play-state:paused; }
  .ticker-item {
    font-family:'Barlow Condensed',sans-serif; font-size:14px; font-weight:600;
    letter-spacing:.5px; text-transform:uppercase; padding-right:60px;
    display:flex; align-items:center; gap:8px;
  }
  .ticker-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
  @keyframes tickerScroll { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }
  .ticker-item.warning  .ticker-dot { background:var(--warning); }
  .ticker-item.watch    .ticker-dot { background:var(--watch); }
  .ticker-item.advisory .ticker-dot { background:var(--advisory); }
  .ticker-item.lsr      .ticker-dot { background:var(--lsr); }
  .ticker-item.statement .ticker-dot { background:var(--statement); }
  .ticker-item.special  .ticker-dot { background:var(--special); }

  .bottom-pad { height:52px; }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--muted); }
</style>
</head>
<body>

<div id="flashOverlay"></div>

<!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
<header>
  <div class="logo-area">
    <div class="radar-icon">
      <svg viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="21" cy="21" r="19" stroke="#00a8e8" stroke-width="1.5" opacity=".25"/>
        <circle cx="21" cy="21" r="13" stroke="#00a8e8" stroke-width="1.5" opacity=".45"/>
        <circle cx="21" cy="21" r="7"  stroke="#00a8e8" stroke-width="1.5" opacity=".65"/>
        <circle cx="21" cy="21" r="2.5" fill="#00a8e8"/>
        <line x1="21" y1="21" x2="37" y2="7" stroke="#00a8e8" stroke-width="2" stroke-linecap="round">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 21 21" to="360 21 21" dur="4s" repeatCount="indefinite"/>
        </line>
        <path d="M21 21 L37 7 A19 19 0 0 0 21 2 Z" fill="#00a8e8" opacity=".12">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 21 21" to="360 21 21" dur="4s" repeatCount="indefinite"/>
        </path>
      </svg>
    </div>
    <div class="logo-text">
      <div class="sub">NWS Live Feed</div>
      <div class="title"><span>Florida</span> Weather Alerts</div>
    </div>
  </div>

  <div class="header-center">
    <div class="fl-outline">â— Jacksonville Â· Tampa Â· Miami Â· Orlando Â· Tallahassee â—</div>
    <div id="newAlertBanner">âš  NEW ALERT ISSUED</div>
  </div>

  <div class="header-right">
    <button class="sound-btn on" id="soundBtn" onclick="toggleSound()">ğŸ”” Sound On</button>
    <div id="statusDot" class="status-dot loading"></div>
    <div class="clock-area">
      <div id="clock" class="clock-time">--:--:--</div>
      <div id="clockDate" class="clock-date">Loading...</div>
    </div>
  </div>
</header>

<!-- â”€â”€â”€ INFO BAR â”€â”€â”€ -->
<div class="info-bar">
  <span class="info-label">Severity:</span>
  <span class="leg-warning">Warning</span>
  <span class="leg-watch">Watch</span>
  <span class="leg-advisory">Advisory</span>
  <span class="leg-statement">Statement</span>
  <span class="leg-lsr">LSR</span>
  <span class="leg-special">Special WX</span>
  <div class="alert-count" id="alertCount">-- Active Florida Alerts</div>
  <div id="lastUpdated">Last update: --</div>
</div>

<!-- â”€â”€â”€ FILTER BAR â”€â”€â”€ -->
<div class="filter-bar">
  <span class="filter-label">Show:</span>
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="warning">Warnings</button>
  <button class="filter-btn" data-filter="watch">Watches</button>
  <button class="filter-btn" data-filter="advisory">Advisories</button>
  <button class="filter-btn" data-filter="statement">Statements</button>
  <button class="filter-btn" data-filter="lsr">LSRs</button>
  <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">âŸ³ Refresh</button>
</div>

<!-- â”€â”€â”€ MAIN â”€â”€â”€ -->
<main>
  <div class="section-header">
    Active Florida Alerts
    <span class="badge" id="alertBadge">--</span>
    <span style="font-size:10px;color:var(--muted);letter-spacing:1px;font-weight:400">NEWEST FIRST</span>
  </div>
  <div id="alertsContainer">
    <div class="loading-shimmer"></div>
    <div class="loading-shimmer"></div>
    <div class="loading-shimmer"></div>
  </div>

  <div class="section-header" id="lsrSection" style="display:none">
    Local Storm Reports â€” Florida
    <span class="badge" id="lsrBadge">--</span>
  </div>
  <div id="lsrContainer" class="lsr-grid"></div>

  <div class="bottom-pad"></div>
</main>

<!-- â”€â”€â”€ TICKER â”€â”€â”€ -->
<div class="ticker-wrap">
  <div class="ticker-label">â˜€ Florida WX</div>
  <div class="ticker-content" id="ticker"></div>
</div>

<script>
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  CONFIG
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const NWS_URL = 'https://api.weather.gov/alerts/active?status=actual&area=FL';
const REFRESH_MS = 90_000; // 90 seconds
let allAlerts   = [];
let allLSRs     = [];
let knownIds    = new Set();
let activeFilter = 'all';
let soundEnabled = true;
let audioCtx = null;
let expireTimers = new Map();
let firstLoad = true;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  CLOCK
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('en-US', { hour12: false });
  document.getElementById('clockDate').textContent =
    now.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
}
setInterval(updateClock, 1000);
updateClock();

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  AUDIO â€” Web Audio API tones
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playTone(type) {
  if (!soundEnabled) return;
  try {
    const ctx = getAudioCtx();
    if (ctx.state === 'suspended') ctx.resume();

    // Different tones for severity
    const configs = {
      warning:   [{ freq:880, dur:.12 }, { freq:660, dur:.12 }, { freq:880, dur:.2 }],
      watch:     [{ freq:660, dur:.15 }, { freq:550, dur:.15 }],
      advisory:  [{ freq:520, dur:.2 }],
      lsr:       [{ freq:740, dur:.1 }, { freq:880, dur:.18 }],
      default:   [{ freq:480, dur:.2 }],
    };
    const notes = configs[type] || configs.default;
    let t = ctx.currentTime + 0.05;

    notes.forEach(n => {
      const osc  = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(n.freq, t);
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(0.28, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, t + n.dur);
      osc.start(t);
      osc.stop(t + n.dur + 0.01);
      t += n.dur + 0.03;
    });
  } catch(e) { /* audio blocked */ }
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  const btn = document.getElementById('soundBtn');
  btn.textContent = soundEnabled ? 'ğŸ”” Sound On' : 'ğŸ”• Sound Off';
  btn.className = 'sound-btn ' + (soundEnabled ? 'on' : 'off');
  if (soundEnabled) playTone('advisory');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  SEVERITY
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getSeverityClass(event) {
  const e = (event || '').toLowerCase();
  if (e.includes(' warning')) return 'warning';
  if (e.includes('watch'))    return 'watch';
  if (e.includes('special weather') || e.includes('urgent weather')) return 'special';
  if (e.includes('advisory') || e.includes('dense fog') || e.includes('freezing fog')) return 'advisory';
  if (e.includes('statement') || e.includes('outlook') || e.includes('discussion')) return 'statement';
  return 'advisory';
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  FETCH
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
async function fetchAlerts() {
  setStatus('loading');
  try {
    const res = await fetch(NWS_URL, {
      headers: {
        'User-Agent': 'FloridaWxAlerts/1.0 (howpomp.github.io/USWxAlerts)',
        'Accept': 'application/geo+json'
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    processAlerts(data.features || []);
    setStatus('ok');
    document.getElementById('lastUpdated').textContent =
      'Updated: ' + new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
  } catch(err) {
    console.error(err);
    setStatus('error');
    if (firstLoad) showError(err.message);
  }
  firstLoad = false;
}

function setStatus(s) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot' + (s==='ok'?'': s==='loading'?' loading':' error');
}

function showError(msg) {
  document.getElementById('alertsContainer').innerHTML =
    `<div class="empty-state"><div class="big-icon">âš </div><p>Failed: ${msg}</p></div>`;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  PROCESS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function processAlerts(features) {
  const now = new Date();
  const newAlerts = [];
  const newLSRs   = [];
  const freshIds  = new Set();

  features.forEach(f => {
    const props = f.properties;
    const event = props.event || '';
    const expires = props.expires ? new Date(props.expires) : null;
    if (expires && expires < now) return;

    const id = props.id || f.id;
    freshIds.add(id);

    const isLSR = event.toLowerCase().includes('local storm report');
    const sevClass = getSeverityClass(event);

    const obj = {
      id, event, sevClass, isLSR,
      headline:    props.headline || event,
      description: props.description || '',
      areas:       props.areaDesc || '',
      sent:        props.sent ? new Date(props.sent) : props.effective ? new Date(props.effective) : props.onset ? new Date(props.onset) : now,
      onset:       props.onset ? new Date(props.onset) : now,
      expires,
      sender:      props.senderName || 'NWS',
      isNew:       !knownIds.has(id),
      magnitude:   parseMagnitude(props.description || ''),
      reporter:    extractReporter(props.description || ''),
      remark:      extractRemark(props.description || ''),
    };

    if (isLSR) newLSRs.push(obj);
    else       newAlerts.push(obj);
  });

  // detect new products
  const brandNew = [...newAlerts, ...newLSRs].filter(a => a.isNew);

  if (!firstLoad && brandNew.length > 0) {
    handleNewAlerts(brandNew);
  }

  // Update known IDs
  knownIds = freshIds;

  // Sort newest-first by actual sent/issued time
  newAlerts.sort((a, b) => b.sent - a.sent);
  newLSRs.sort((a, b) => b.sent - a.sent);

  allAlerts = newAlerts;
  allLSRs   = newLSRs;

  updateCount();
  renderAlerts();
  renderLSRs();
  renderTicker();
}

function handleNewAlerts(items) {
  // Flash screen
  const overlay = document.getElementById('flashOverlay');
  overlay.classList.remove('flash');
  void overlay.offsetWidth;
  overlay.classList.add('flash');

  // Show banner
  const banner = document.getElementById('newAlertBanner');
  banner.classList.add('visible');
  setTimeout(() => banner.classList.remove('visible'), 8000);

  // Play tone based on highest severity new item
  const hasSevere = items.some(a => a.sevClass === 'warning');
  const hasWatch  = items.some(a => a.sevClass === 'watch');
  const hasLSR    = items.some(a => a.isLSR);
  if (hasSevere) playTone('warning');
  else if (hasWatch) playTone('watch');
  else if (hasLSR) playTone('lsr');
  else playTone('advisory');

  // Update banner text
  banner.textContent = `âš  ${items.length} NEW PRODUCT${items.length>1?'S':''} ISSUED`;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  HELPERS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function parseMagnitude(desc) {
  const m = desc.match(/(\d+\.?\d*)\s*(INCHES|INCH|MPH|MM|FEET|FT)/i);
  return m ? `${m[1]} ${m[2].toLowerCase()}` : null;
}
function extractReporter(desc) {
  const m = desc.match(/SOURCE\.\.\.\s*(.+?)(?:\n|$)/i);
  return m ? m[1].trim() : null;
}
function extractRemark(desc) {
  const m = desc.match(/REMARKS?\.\.\.\s*(.+?)(?:\n\n|$)/is);
  if (m) return m[1].replace(/\n/g,' ').trim();
  return desc.slice(0,250).replace(/\n/g,' ').trim();
}
function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtTime(d) {
  if (!d) return '';
  return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
}
function fmtDate(d) {
  if (!d) return '';
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}
function timeSince(d) {
  const mins = Math.round((Date.now() - d) / 60000);
  if (mins < 1)  return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  return `${hrs}h ${mins%60}m ago`;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  RENDER ALERTS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function filteredAlerts() {
  if (activeFilter === 'all') return allAlerts;
  return allAlerts.filter(a => a.sevClass === activeFilter);
}

function renderAlerts() {
  const container = document.getElementById('alertsContainer');
  expireTimers.forEach(t => clearTimeout(t));
  expireTimers.clear();

  const alerts = filteredAlerts();
  if (alerts.length === 0) {
    container.innerHTML = `<div class="no-alerts-msg">No active Florida alerts matching this filter â€” skies are clear! â˜€</div>`;
    return;
  }

  container.innerHTML = '';
  alerts.forEach(a => {
    const card = buildCard(a);
    container.appendChild(card);
    scheduleExpire(a, card);
  });
}

function buildCard(a) {
  const card = document.createElement('div');
  card.className = `alert-card ${a.sevClass}${a.isNew ? ' is-new' : ''}`;
  card.dataset.id = a.id;

  let expiresHTML = '', countdownPct = 100;
  if (a.expires) {
    const minsLeft = Math.round((a.expires - Date.now()) / 60000);
    const totalMins = Math.max(1, Math.round((a.expires - a.onset) / 60000));
    countdownPct = Math.max(0, Math.min(100, (minsLeft / totalMins) * 100));
    const urgClass = minsLeft < 30 ? 'urgent' : minsLeft < 90 ? 'soon' : '';
    expiresHTML = `<div class="alert-expires ${urgClass}">
      <span class="exp-label">Expires</span>
      ${fmtDate(a.expires)} ${fmtTime(a.expires)}
      ${minsLeft < 120 ? `<br><span style="font-size:10px">(${minsLeft} min${minsLeft===1?'':'s'})</span>` : ''}
    </div>`;
  }

  const areas = a.areas.split(';').slice(0,5).join('; ');
  const moreAreas = a.areas.split(';').length > 5 ? ` +${a.areas.split(';').length-5} more` : '';
  const safeId = a.id.replace(/[^a-zA-Z0-9]/g,'_');

  card.innerHTML = `
    <div class="alert-type-badge">${a.sevClass.toUpperCase()}</div>
    <div class="alert-body">
      <div class="alert-headline">
        ${escHtml(a.event)}
        <span class="new-tag">NEW</span>
      </div>
      <div class="alert-issued">
        Issued: ${fmtDate(a.sent)} ${fmtTime(a.sent)}
        <span class="issued-new">${a.isNew ? ' â€” ' + timeSince(a.sent) : ''}</span>
      </div>
      <div class="alert-areas"><strong>Areas:</strong> ${escHtml(areas)}${moreAreas ? `<em style="color:var(--muted)"> ${moreAreas}</em>` : ''}</div>
      <div class="alert-description" id="desc-${safeId}">${escHtml(a.remark || a.description.slice(0,300))}</div>
      <button class="expand-btn" onclick="toggleExpand(this,'${safeId}')">+ More</button>
    </div>
    <div class="alert-meta">
      ${expiresHTML}
      <div class="countdown-bar"><div class="countdown-fill" style="width:${countdownPct}%"></div></div>
      <div class="nwso-tag">${escHtml(a.sender.replace('NWS ',''))}</div>
    </div>
  `;

  return card;
}

function toggleExpand(btn, id) {
  const desc = document.getElementById('desc-' + id);
  if (!desc) return;
  const expanded = desc.classList.toggle('expanded');
  btn.textContent = expanded ? '- Less' : '+ More';
}

function scheduleExpire(a, card) {
  if (!a.expires) return;
  const msLeft = a.expires - Date.now();
  if (msLeft <= 0) { card.remove(); return; }
  const t = setTimeout(() => {
    card.classList.add('expiring');
    setTimeout(() => { card.remove(); updateCount(); }, 1000);
  }, msLeft);
  expireTimers.set(a.id, t);
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  RENDER LSRs
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function renderLSRs() {
  const container = document.getElementById('lsrContainer');
  const section   = document.getElementById('lsrSection');
  const lsrs = (activeFilter === 'all' || activeFilter === 'lsr') ? allLSRs : [];

  if (lsrs.length === 0) { section.style.display='none'; container.innerHTML=''; return; }
  section.style.display = 'flex';
  document.getElementById('lsrBadge').textContent = lsrs.length;
  container.innerHTML = '';

  lsrs.slice(0,24).forEach(l => {
    const card = document.createElement('div');
    card.className = 'lsr-card' + (l.isNew ? ' is-new' : '');
    card.innerHTML = `
      <div class="lsr-card-header">
        <div class="lsr-event-type">${escHtml(l.event.replace(/local storm report/i,'').trim()||l.event)}</div>
        <div class="lsr-time">${fmtDate(l.sent)} ${fmtTime(l.sent)}</div>
      </div>
      ${l.magnitude ? `<div class="lsr-magnitude">${escHtml(l.magnitude)}</div>` : ''}
      <div class="lsr-location">${escHtml(l.areas.split(';')[0]||'')}</div>
      ${l.reporter ? `<div class="lsr-reporter">Source: ${escHtml(l.reporter)}</div>` : ''}
      ${l.remark   ? `<div class="lsr-remark">${escHtml(l.remark.slice(0,180))}</div>` : ''}
    `;
    container.appendChild(card);
  });
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  TICKER
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function renderTicker() {
  const ticker = document.getElementById('ticker');
  const items  = [...filteredAlerts().slice(0,40), ...allLSRs.slice(0,8)];

  if (items.length === 0) {
    ticker.innerHTML = '<div class="ticker-item" style="color:var(--muted)">No active Florida weather alerts at this time â˜€</div>';
    return;
  }
  const all = [...items, ...items];
  ticker.innerHTML = all.map(a => `
    <div class="ticker-item ${a.sevClass||'lsr'}">
      <div class="ticker-dot"></div>
      ${escHtml(a.event)} â€” ${escHtml((a.areas.split(';')[0]||'').trim())}
      ${a.sent ? ` Â· Issued ${fmtTime(a.sent)}` : ''}
      ${a.expires ? ` Â· Exp ${fmtTime(a.expires)}` : ''}
    </div>
  `).join('');
  ticker.style.animationDuration = Math.max(30, items.length * 5) + 's';
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  COUNT
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function updateCount() {
  const total = allAlerts.length + allLSRs.length;
  const warns = allAlerts.filter(a => a.sevClass==='warning').length;
  document.getElementById('alertCount').textContent =
    `${total} Active Alert${total!==1?'s':''} Â· ${warns} Warning${warns!==1?'s':''}`;
  document.getElementById('alertBadge').textContent = filteredAlerts().length;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  FILTERS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderAlerts();
    renderLSRs();
    renderTicker();
    updateCount();
  });
});

function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  btn.textContent = 'âŸ³ Refreshing...';
  fetchAlerts().finally(() => {
    btn.classList.remove('spinning');
    btn.textContent = 'âŸ³ Refresh';
  });
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  COUNTDOWN TICK (every 60s)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
setInterval(() => {
  document.querySelectorAll('.alert-card').forEach(card => {
    const a = allAlerts.find(x => x.id === card.dataset.id);
    if (!a || !a.expires) return;
    const minsLeft  = Math.round((a.expires - Date.now()) / 60000);
    const totalMins = Math.max(1, Math.round((a.expires - a.onset) / 60000));
    const pct = Math.max(0, Math.min(100, (minsLeft / totalMins) * 100));
    const fill = card.querySelector('.countdown-fill');
    if (fill) fill.style.width = pct + '%';
  });
}, 60_000);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  BOOT
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
setInterval(fetchAlerts, REFRESH_MS);
fetchAlerts();
</script>
</body>
</html>
